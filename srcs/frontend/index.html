<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<script type="module" src="./src/login.ts"></script>
<body>
    <main id="app"></main>

    <script type="module">
        import { backendLogin, logout } from './src/login';
        import { backendSignup } from './src/signup';
        import { fetchDashboard } from './src/dashboard';
        import { renderPong } from './src/pong';

        const app = document.getElementById('app');

        const routes = {
            login: renderLogin,
            signup: renderSignup,
            dashboard: renderDashboard,
            pong: renderPong,
        };

        function renderLogin() {
            app.innerHTML  = `
            <form id="login-form">
                <input name="email" type="email" class="input" required/>
                <input name="password" type="password" class="'input" required/>
                <button type="submit" class="'btn">Login</button>
            </form>
            <a href="#signup" class="'btn">Signup instead</a>
            <div id="message"></div>`;

            backendLogin();
        };

        function renderSignup() {
            app.innerHTML = `
            <form id="signup-form">
                <label>Firstname: <input name="firstname" type="text" class="'input" required/>
                <label>Lastname: <input name="lastname" type="text" class="'input" required/></label><br><br>
                <label>Username: <input name="username" type="text" class="'input" required/></label><br><br>
                <label>Email: <input name="email" type="email" class="'input" required/></label>
                <label>Password: <input name="password" type="password" class="'input" required/>
                <button type="submit" class="btn">Sign-up</button>
            </form>
            <div id="message"></div>`;

            backendSignup();
        };

        function renderDashboard() {
            app.innerHTML = `
            <div name="options">
                <button>Profile</button>
                <button>Play</button>
                <button>History</button>
                <button id="logoutBtn" class="btn">log out</button>
            </div>`;

            fetchDashboard();
            logout();
        };

        function router() {
            let rawHash = location.hash.slice(1);

            // Extract only first segment before '/' or '#'
            let firstSegment = rawHash.split(/[\/#]/)[0].toLowerCase();
            // Check if firstSegment is a valid route
            const isValidRoute = firstSegment && routes.hasOwnProperty(firstSegment);
            if (!isValidRoute) {
                // Replace URL with default route '#login' if invalid or empty
                const defaultRoute = 'login';
                const baseURL = location.origin + location.pathname;
                history.replaceState(null, '', baseURL + '#' + defaultRoute);
                firstSegment = defaultRoute;
            } else {
                // If original hash had extra junk beyond first segment, clean URL
                if (rawHash !== firstSegment) {
                    const baseURL = location.origin + location.pathname;
                    history.replaceState(null, '', baseURL + '#' + firstSegment);
                }
            }
            const render = routes[firstSegment] || renderLogin;
            render();
        }

        window.addEventListener('hashchange', router);
        window.addEventListener('DOMContentLoaded', router);
        </script>
</body>
</html>